# Gewechat Web客户端详细开发计划

## 项目概述

基于Gewechat API开发Web版微信客户端，实现扫码登录、消息收发、联系人管理等核心功能，采用轻量级架构设计，使用FastAPI后端和简洁前端界面。

## 技术栈选择

- **后端**: FastAPI（异步高性能，支持WebSocket）
- **数据库**: SQLite（轻量级，便于部署）
- **前端**: Vanilla JS/CSS（轻量级实现）
- **通信**: HTTP API + WebSocket（实时消息推送）
- **部署**: Docker容器化（可选）

## 迭代开发计划

### 阶段一：基础架构与认证系统（1周）

**目标**: 搭建项目基础框架，实现简单认证系统

| 任务 | 描述 | 验收标准 |
|-----|------|--------|
| 1.1 项目结构初始化 | 创建项目目录结构，配置基本依赖 | 项目结构完整，能成功启动服务 |
| 1.2 数据库设计与实现 | 设计并实现SQLite数据库模型 | 数据库模型正确定义，能执行基本CRUD操作 |
| 1.3 认证系统实现 | 实现基于授权码的登录与会话管理 | 能成功验证授权码，生成会话，保护API端点 |
| 1.4 基础API路由设置 | 设置基本的API路由结构 | API路由正确响应请求，返回适当状态码 |
| 1.5 错误处理与日志 | 实现统一错误处理和日志系统 | 错误能被捕获并记录，返回合适的错误信息 |

### 阶段二：Gewechat登录模块（1周）

**目标**: 实现微信扫码登录功能，管理登录状态

| 任务 | 描述 | 验收标准 |
|-----|------|--------|
| 2.1 Token获取 | 实现获取Gewechat Token的API | 成功获取并保存Token |
| 2.2 二维码生成 | 实现获取登录二维码的API | 能生成并显示可用的登录二维码 |
| 2.3 登录状态检查 | 实现登录状态轮询机制 | 能正确检测扫码状态和登录结果 |
| 2.4 会话持久化 | 保存登录信息和设备ID | 登录信息正确存储，重启应用后仍可用 |
| 2.5 回调URL设置 | 设置消息回调URL | 回调URL成功配置，能接收测试消息 |
| 2.6 断线重连机制 | 实现状态检查和断线重连 | 检测到掉线能自动尝试重连 |
| 2.7 前端登录界面 | 实现简单的登录界面 | 显示二维码，指示登录状态，成功后跳转 |

### 阶段三：消息接收与处理（2周）

**目标**: 实现消息回调接收与存储，建立实时通信机制

| 任务 | 描述 | 验收标准 |
|-----|------|--------|
| 3.1 回调接收接口 | 实现接收Gewechat回调的端点 | 成功接收并解析回调消息 |
| 3.2 消息排重机制 | 实现基于Appid+NewMsgId的消息排重 | 重复消息不会重复处理 |
| 3.3 消息存储系统 | 设计并实现消息数据库模型 | 消息正确存储到数据库 |
| 3.4 消息类型处理器 | 为不同消息类型实现处理逻辑 | 能正确处理文本、图片、系统通知等消息 |
| 3.5 媒体文件下载 | 实现图片、视频等媒体文件下载 | 收到媒体消息后能下载并保存媒体文件 |
| 3.6 WebSocket服务 | 实现WebSocket服务器推送消息 | 消息能实时推送到前端 |
| 3.7 前端消息展示 | 实现基本的消息列表和详情界面 | 前端能实时展示接收到的消息 |

### 阶段四：消息发送功能（1.5周）

**目标**: 实现各类消息的发送功能

| 任务 | 描述 | 验收标准 |
|-----|------|--------|
| 4.1 文本消息发送 | 实现发送文本消息的API | 能成功发送文本消息并收到回执 |
| 4.2 图片消息发送 | 实现上传和发送图片的功能 | 能上传图片并发送到聊天 |
| 4.3 文件消息发送 | 实现上传和发送文件的功能 | 能上传文件并发送到聊天 |
| 4.4 媒体转发功能 | 实现已有媒体的高效转发 | 能使用CDN信息快速转发媒体消息 |
| 4.5 前端发送界面 | 实现消息发送输入框和上传控件 | 用户能通过界面编辑和发送各类消息 |

### 阶段五：联系人管理（1.5周）

**目标**: 实现联系人和群组管理功能

| 任务 | 描述 | 验收标准 |
|-----|------|--------|
| 5.1 联系人获取 | 实现获取联系人列表的API | 能获取并存储完整联系人信息 |
| 5.2 联系人详情 | 实现获取联系人详细信息的API | 能查看联系人的详细资料 |
| 5.3 好友搜索 | 实现联系人搜索功能 | 能通过关键词搜索联系人 |
| 5.4 联系人操作 | 实现添加、删除好友等功能 | 能执行联系人管理操作 |
| 5.5 前端联系人列表 | 实现联系人和群组列表界面 | 显示联系人列表，支持搜索和操作 |

### 阶段六：聊天界面优化（1周）

**目标**: 完善聊天界面和用户体验

| 任务 | 描述 | 验收标准 |
|-----|------|--------|
| 6.1 聊天界面设计 | 优化聊天界面布局和样式 | 聊天界面美观易用，支持各类消息显示 |
| 6.2 消息加载优化 | 实现分页加载和历史消息查询 | 能流畅加载历史消息，无卡顿 |
| 6.3 媒体预览 | 实现图片、视频预览功能 | 能直接预览媒体内容，支持缩放和播放 |
| 6.4 消息状态指示 | 显示消息发送、接收状态 | 用户能清楚了解消息发送状态 |
| 6.5 消息通知 | 实现未读消息通知和提醒 | 有新消息时提供适当的通知 |

### 阶段七：测试、优化与部署（1周）

**目标**: 全面测试系统，优化性能，准备部署

| 任务 | 描述 | 验收标准 |
|-----|------|--------|
| 7.1 单元测试 | 为核心组件编写单元测试 | 测试覆盖关键功能，通过率>90% |
| 7.2 集成测试 | 编写API和系统集成测试 | 主要功能流程测试通过 |
| 7.3 性能优化 | 识别并解决性能瓶颈 | 系统能在预期负载下稳定运行 |
| 7.4 安全审查 | 检查并加固安全措施 | 无明显安全漏洞，敏感数据受保护 |
| 7.5 部署文档 | 编写部署和配置文档 | 文档详细准确，能按文档成功部署 |
| 7.6 Docker容器化 | 创建Docker镜像和配置 | 能通过Docker快速部署应用 |

## 项目结构

```
gewechat-web/
├── app/
│   ├── api/                     # API路由
│   │   ├── auth.py              # 认证相关API
│   │   ├── callback.py          # 回调接收API
│   │   ├── wechat.py            # 微信功能API
│   │   └── ...
│   ├── core/                    # 核心配置
│   │   ├── auth.py              # 认证逻辑
│   │   ├── config.py            # 配置管理
│   │   └── ...
│   ├── database/                # 数据库操作
│   │   ├── models.py            # 数据模型
│   │   ├── database.py          # 数据库连接
│   │   └── ...
│   ├── services/                # 业务逻辑
│   │   ├── message_service.py   # 消息处理服务
│   │   ├── wechat_service.py    # 微信API服务
│   │   └── ...
│   ├── websockets/              # WebSocket实现
│   │   ├── manager.py           # WebSocket管理
│   │   └── ...
│   └── main.py                  # 应用入口
├── static/                      # 静态资源
│   ├── css/
│   ├── js/
│   └── ...
├── templates/                   # HTML模板
│   ├── index.html
│   ├── login.html
│   └── ...
├── tests/                       # 测试目录
│   ├── test_api/
│   ├── test_services/
│   └── ...
├── .env.example                 # 环境变量示例
├── .gitignore                   # Git忽略文件
├── requirements.txt             # 依赖列表
├── Dockerfile                   # Docker配置
├── docker-compose.yml           # Docker Compose配置
└── README.md                    # 项目说明
```

## 数据库模型概要

1. **Users表**
   - id, username, created_at, last_login, auth_level

2. **WechatAccounts表**
   - id, wxid, nickname, appid, token, last_online, callback_url, status

3. **Contacts表**
   - id, wxid, nickname, remark, avatar_url, account_id, contact_type, is_in_contact_list

4. **Groups表**
   - id, group_id, name, owner_wxid, avatar_url, account_id, member_count

5. **GroupMembers表**
   - id, group_id, member_wxid, nickname, account_id

6. **Messages表**
   - id, msg_id, new_msg_id, app_id, from_wxid, to_wxid, content, type, status, created_at, media_url

7. **MediaFiles表**
   - id, msg_id, file_type, file_url, thumb_url, aes_key, file_id, local_path, created_at

## 里程碑时间线

- **里程碑1**: 基础架构与认证系统完成 - 1周
- **里程碑2**: Gewechat登录模块完成 - 2周
- **里程碑3**: 消息接收与处理系统完成 - 4周
- **里程碑4**: 消息发送功能完成 - 5.5周
- **里程碑5**: 联系人管理功能完成 - 7周
- **里程碑6**: 聊天界面优化完成 - 8周
- **里程碑7**: 系统测试与部署完成 - 9周

## 开发注意事项

1. **测试优先**: 为每个模块先编写测试用例，然后实现功能
2. **渐进式开发**: 优先实现核心功能，确保稳定后再添加扩展功能
3. **安全意识**: 妥善处理用户数据和授权，定期审查安全措施
4. **文档同步**: 与代码开发同步更新文档
5. **规范统一**: 遵循一致的代码规范和命名约定
6. **异常处理**: 完善的错误处理和日志记录，方便调试和排错
7. **性能考虑**: 特别关注消息处理、媒体下载等可能的性能瓶颈
